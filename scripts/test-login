#
# Test access to WebTop 5
# The script takes 3 arguments:
# - username
# - password
# - url
#
# The script exit 0 on success, 1 on error.
#

USER=$1
PASSWORD=$2
BASE_URL=$3

if [ -z "$1" ] || [ -z "$2" ] ||  [ -z "$3" ]; then
    echo "Usage: $0 <user> <password> <url>"
    exit 2
fi

# Read cookie
COOKIE=$(curl -k -sL -I $BASE_URL | grep "Set-Cookie" | awk '{print $2}')
# Set JSESSIONID variable
eval $COOKIE

# Prepare url for login
quoted=$(python -c "import urllib, sys; print urllib.quote_plus(sys.argv[1])" $BASE_URL)

# Execute the login and retrieve a JSON contained in the body
data=$(curl -k -sL $BASE_URL"/login" -H "Cookie: JSESSIONID=$JSESSIONID" --data "location=$quoted&wtusername=$USER&wtpassword=$PASSWORD&wtdomain=NethServer" | grep 'WTS = {"session' | cut -d'=' -f2)
name=$(echo $data| jq -cr '.servicesVars[0].userDisplayName' 2>/dev/null)

# Extract the sessionid: if it's empty, login has failed
sessionid=$(echo $data| jq -cr '.sessionId' 2>/dev/null)

if [ -z $sessionid ]; then
    echo "[ERROR] USER: $USER URL: $BASE_URL"
    exit 1
else
    exit 0
fi
